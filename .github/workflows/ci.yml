name: CI Pipeline

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest-cov

      - name: Create Dummy Data for Training
        run: |
          mkdir -p data/raw
          echo "TransactionId,BatchId,AccountId,SubscriptionId,CustomerId,CurrencyCode,CountryCode,ProviderId,ProductId,ProductCategory,ChannelId,Amount,Value,TransactionStartTime,PricingStrategy,FraudResult" > data/raw/data.csv
          
          # Create 6 Low-Risk samples (Small amounts, no fraud)
          for i in {1..6}; do
            echo "T$i,B$i,Acc_Low_$i,S$i,C$i,UGX,256,P1,Pr1,airtime,Ch1,100,100,2018-11-15T02:18:49Z,2,0" >> data/raw/data.csv
          done
          
          # Create 6 High-Risk samples (Large amounts, marked fraud)
          for i in {7..12}; do
            echo "T$i,B$i,Acc_High_$i,S$i,C$i,UGX,256,P1,Pr1,airtime,Ch1,10000,10000,2018-11-15T02:25:49Z,2,1" >> data/raw/data.csv
          done
          
      - name: Pre-Train and Register Champion
        env:
          MLFLOW_TRACKING_URI: sqlite:///mlflow.db
          PYTHONPATH: ${{ github.workspace }}/src
        run: |
          # Run training to generate the DB
          python src/train.py
          
          # Manually tag it as 'champion' so the API finds it
          python -c "
          import mlflow
          from mlflow import MlflowClient
          client = MlflowClient(tracking_uri='sqlite:///mlflow.db')
          latest_version = client.get_latest_versions('Bati_Bank_Credit_Model')[0].version
          client.set_registered_model_alias('Bati_Bank_Credit_Model', 'champion', latest_version)
          "

      - name: Run Pipeline Tests
        env:
          MLFLOW_TRACKING_URI: sqlite:///mlflow.db
          PYTHONPATH: ${{ github.workspace }}/src
        run: |
          pytest tests/pipeline_test.py